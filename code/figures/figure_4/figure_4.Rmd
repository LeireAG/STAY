---
title: "figure_4"
Aim: investigating areas of detachment by Non-Negative Matrix factorization and deconvolution with the NNLS method
---

```{r}
library(semla)
library(singlet)
library(ggplot2)
library(tidyverse)
library(dplyr)
```

Run NMF the normalized Seurat object but excluding reductions. 
```{r}
# Normalize data and find top variable features
vis_mod_norm <- vis_mod |> 
  NormalizeData() |> 
  FindVariableFeatures()
```

```{r}
## Run NMF
set.seed(42)
vis_mod_nmf <- RunNMF(vis_mod_norm, assay = "RNA3") #k = 20 (if I want exactly 20 factors)
```


```{r}
#### Save object
saveRDS(vis_mod_nmf,
        file = paste0("/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/output/rds_objects/", "vis_mod_nmf.rds"))
```

```{r, eval = FALSE}
vis_mod_nmf <- readRDS(paste0("/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/output/rds_objects/", "vis_mod_nmf.rds"))
```

```{r}
#### Check optimal number of factors k
k <- ncol(vis_mod_nmf@reductions$nmf@feature.loadings)
k
```

```{r}
#### Print factorization rank
#pdf(paste0(plot.dir, "/RankPlot_nmf", ".pdf"), width = 25, height = 12)
print(RankPlot(vis_mod_nmf))
#dev.off()
```

Functional Enrichment Analysis to indentify the gene ontology of the gene programmes in each factor
```{r}
#Extract feature loadings from DimReduc object for each factor to run Func Enrich Analysis
nmf_loadings <- vis_mod_nmf[["nmf"]]@feature.loadings

# Convert to long format and group data by factor
gene_loadings_sorted <- nmf_loadings |> 
  as.data.frame() |> 
  tibble::rownames_to_column(var = "gene") |> 
  as_tibble() |> 
  tidyr::pivot_longer(all_of(colnames(nmf_loadings)), names_to = "fctr", values_to = "loading") |> 
  mutate(fctr = factor(fctr, colnames(nmf_loadings))) |> 
  group_by(fctr) |> 
  arrange(fctr, -loading)

# Extract top 10 genes per factor
gene_loadings_sorted |> 
  slice_head(n = 10)
```

#Factor 20 and 16 were interesting by its spatial distribution matching well defined areas of fibrous stroma and desmoplastic stroma
## Run functional enrichment analysis on top 10 genes from factor 20
```{r}
library(gprofiler2)

# Get gene sets
gene_set_nmf_20 <- gene_loadings_sorted |> 
  filter(fctr == "NMF_20") |> 
  slice_head(n = 10)

# Run FEA. Gene Ontology: Biological Process. In which biological processes are the genes involved?
fea_results_nmf_20 <- gost(query = gene_set_nmf_20$gene, ordered_query = TRUE, organism = "hsapiens", sources = "GO:BP")$result |> 
  as_tibble()

# Look at results
fea_results_nmf_20 |> select(p_value, term_size, query_size, intersection_size, term_name)
```

```{r}
gene_set_nmf_16 <- gene_loadings_sorted |> 
  filter(fctr == "NMF_16") |> 
  slice_head(n = 10)

# Run FEA. Gene Ontology: Biological Process. In which biological processes are the genes involved?
fea_results_nmf_16 <- gost(query = gene_set_nmf_16$gene, ordered_query = TRUE, organism = "hsapiens", sources = "GO:BP")$result |> 
  as_tibble()

# Look at results
fea_results_nmf_16 |> select(p_value, term_size, query_size, intersection_size, term_name)
```

# Make a composite plot --> will only diplay the most dominant factor for each spot
# Select relevant factors that do not overlap like Factor 16 and 20 in Patient 2.

# Code for composite plots in Figure 4 a, b.
```{r, fig.width=14, fig.height=7}
#Define PDF output file
pdf("/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_5/composite_plots/factor_16_20_4393_soft.pdf", width = 16, height = 14)  # Increase size for better visibility. Actually need to improve it. 
pdf("/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_5/composite_plots/factor_16_20_4393_soft_wHE.pdf", width = 16, height = 14)  # Increase size for better

# Select non-overlapping factors
selected_factors <- c(20, 16)

#library(viridis)

# Generate a color vector from the viridis palette (length = number of features you're plotting)
#factor_colors <- viridis(n = length(selected_factors), option = "C")  # Options: "C", "B", etc.
factor_colors <- c('#e6194B', '#46f0f0')
#library(viridis)
#magma_colors <- viridis(10, option = "magma", direction = -1) # replace 10 with the number of colors you need
#cols <- viridis(2, option = "magma", direction = -1) #so NMF 16 is blue and NMF 20 is red matching the path anno palette 
names(cols) <- c("Factor20", "Factor16")
p3 <- MapMultipleFeatures(vis_mod_nmf, 
                    features = paste0("NMF_", selected_factors), 
                    colors = factor_colors, 
                    #color_scale = "viridis",
                    section_number = 3,
                    image_use = "raw", 
                    override_plot_dims = TRUE, 
                    pt_size = 1.7, 
                    max_cutoff = 0.99,  
                    add_colorscale_text = TRUE, 
                    alpha = 1)
print(p3)

dev.off()
png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_5/composite_plots/factor_16_20_4393_soft_wHE.png", width = 14*png_res, height = 7*png_res, res = png_res);print(p3);dev.off()
```

```{r fig.width=14, fig.height=7}
#Define PDF output file
pdf("/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_5/composite_plots/factor_16_20_4393_hard.pdf", width = 16, height = 14) 

pdf("/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_5/composite_plots/factor_16_20_4393_hard_wHE.pdf", width = 16, height = 14) 
selected_factors <- c(20,16)
factor_colors <- c('#e6194B', '#46f0f0')
p4 <- MapMultipleFeatures(vis_mod_nmf, 
                    features = paste0("NMF_", selected_factors), 
                    colors = factor_colors, 
                    #color_scale = "viridis", 
                    section_number = 4,
                    image_use = "raw", 
                    override_plot_dims = TRUE, 
                    pt_size = 1.7, 
                    pt_stroke = 0.9,
                    max_cutoff = 0.99,
                    add_colorscale_text = TRUE, 
                    alpha =1)
print(p4)
dev.off

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_5/composite_plots/factor_16_20_4393_hard_noHE.png", width = 14*png_res, height = 7*png_res, res = png_res);print(p4);dev.off()
```

In figure 4 F we are adding the annotation of demosplastic stroma. A heterogeneous stroma intermingling areas of cancer epithelial cells. 
 if the desmoplastic annotation matches any factor
 
```{r}
# 0. Load data (new Seurat object modified by Sophie)
vis_mod_anno <- readRDS(file = paste0("/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/output/rds_objects/", "vis_mod_anno.rds"))
```

```{r plot_counts, fig.width=11, fig.height=10}
pdf_4335_anno <- "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_5/epithelial_stroma_anno/4335_hard_anno.pdf"
pdf(file = pdf_4335_anno, width = 11, height = 10)
# Here we use the & operator from the patchwork R package to add a theme
# You can find more details in the 'advanced' tutorial
epithelial_colors <- c('#911eb4', '#f58231',"#3c4cff", "#eeeeee")

p1 <- MapLabels(vis_mod_anno, column_name = "Epithelial_Anno", colors = epithelial_colors, pt_size = 1, pt_alpha = 0.5, pt_stroke = NA, section_number = 1, ncol = 1) &
  theme(legend.position = "right")

stroma_colors <- c('#ffe119',"#e6194B", '#46f0f0', "#eeeeee")
# Here we use the & operator from the patchwork R package to add a theme
# You can find more details in the 'advanced' tutorial
p2 <- MapLabels(vis_mod_anno, column_name = "Stroma_Anno", colors = stroma_colors, pt_size = 1, pt_alpha = 0.5, pt_stroke = NA, section_number = 1, ncol = 1) &
  theme(legend.position = "right")

#adding immune annotation
immune_colors <- 
p3 <- MapLabels(vis_mod_anno, column_name = "Immune_Anno", colors = stroma_colors, pt_size = 1, pt_alpha = 0.5, pt_stroke = NA, section_number = 1, ncol = 1) &
  theme(legend.position = "right")

p_anno <- p1 | p2 | p3
print(p_anno)

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_5/epithelial_stroma_anno/4335_hard_anno.png", width = 11*png_res, height = 10*png_res, res = png_res);print(p_anno);dev.off()
```

```{r}
# Merge columns into one
vis_mod_anno@meta.data <- vis_mod_anno@meta.data %>%
  mutate(curated_metadata = paste(Epithelial_Anno, Stroma_Anno))

# Check result
head(vis_mod_anno@meta.data)

```

```{r}
MapLabels(vis_mod_anno, column_name = "curated_metadata", ncol = 1, pt_size = 1.3, pt_alpha = 1, pt_stroke = NA, section_number = 1) &
  theme(legend.position = "right")
```


```{r plot_counts, fig.width=11, fig.height=10}
pdf_4393_anno <- "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_5/epithelial_stroma_anno/4393_hard_anno.pdf"
pdf(file = pdf_4393_anno, width = 11, height = 10)

# Here we use the & operator from the patchwork R package to add a theme
# You can find more details in the 'advanced' tutorial
epithelial_colors <- c('#911eb4', '#f58231',"#3c4cff", "#eeeeee")

p1 <- MapLabels(vis_mod, column_name = "Epithelial_Anno", colors = epithelial_colors, pt_size = 1.3, pt_alpha = 1, pt_stroke = NA, section_number = 4, ncol = 1) &
  theme(legend.position = "right")

stroma_colors <- c('#ffe119',"#e6194B", '#46f0f0', "#eeeeee")
# Here we use the & operator from the patchwork R package to add a theme
# You can find more details in the 'advanced' tutorial
p2 <- MapLabels(vis_mod, column_name = "Stroma_Anno", colors = stroma_colors, pt_size = 1.3, pt_alpha = 1 , pt_stroke = NA, section_number = 4, ncol = 1) &
  theme(legend.position = "right")

p_anno <- p1 | p2
print(p_anno)

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_5/epithelial_stroma_anno/4393_hard_anno.png", width = 11*png_res, height = 10*png_res, res = png_res);print(p_anno);dev.off()
```

```{r plot_counts, fig.width=11, fig.height=10}

# Here we use the & operator from the patchwork R package to add a theme
# You can find more details in the 'advanced' tutorial
pdf_4515_anno <- "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_5/epithelial_stroma_anno/4515_hard_anno.pdf"
pdf(file = pdf_4515_anno, width = 11, height = 10)
epithelial_colors <- c('#911eb4', '#f58231',"#3c4cff", "#eeeeee")

p1 <- MapLabels(vis_mod, column_name = "Epithelial_Anno", colors = epithelial_colors, pt_size = 1, pt_alpha = 0.5, pt_stroke = NA, section_number = 8, ncol = 1) &
  theme(legend.position = "right")

stroma_colors <- c('#ffe119',"#e6194B", '#46f0f0', "#eeeeee")
# Here we use the & operator from the patchwork R package to add a theme
# You can find more details in the 'advanced' tutorial
p2 <- MapLabels(vis_mod, column_name = "Stroma_Anno", colors = stroma_colors, pt_size = 1, pt_alpha = 0.5 , pt_stroke = NA, section_number = 8, ncol = 1) &
  theme(legend.position = "right")

p_anno_4515 <- p1 | p2
print(p_anno_4515)
png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_5/epithelial_stroma_anno/4515_hard_anno.png", width = 11*png_res, height = 10*png_res, res = png_res);print(p_anno_4515);dev.off()
```

```{r plot_counts, fig.width=11, fig.height=10}
pdf_4419_anno <- "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_5/epithelial_stroma_anno/4419_hard_anno.pdf"
pdf(file = pdf_4419_anno, width = 11, height = 10)
# Here we use the & operator from the patchwork R package to add a theme
# You can find more details in the 'advanced' tutorial

epithelial_colors <- c('#911eb4', '#f58231',"#3c4cff", "#eeeeee")

p1 <- MapLabels(vis_mod, column_name = "Epithelial_Anno", colors = epithelial_colors, pt_size = 1.3, pt_alpha = 1, pt_stroke = NA, section_number = 6, ncol = 1) &
  theme(legend.position = "right")

stroma_colors <- c('#ffe119',"#e6194B", '#46f0f0', "#eeeeee")
# Here we use the & operator from the patchwork R package to add a theme
# You can find more details in the 'advanced' tutorial
p2 <- MapLabels(vis_mod, column_name = "Stroma_Anno", colors = stroma_colors, pt_size = 1.3, pt_alpha = 1 , pt_stroke = NA, section_number = 6, ncol = 1) &
  theme(legend.position = "right")

p_anno_4419 <- p1 | p2
print(p_anno_4419)
png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_5/epithelial_stroma_anno/4419_hard_anno.png", width = 11*png_res, height = 10*png_res, res = png_res);print(p_anno_4419);dev.off()
```


```{r plot_counts, fig.width=8, fig.height=8}}
#annotation_colors <- c('#ffe119', '#46f0f0',"#eeeeee")
# Here we use the & operator from the patchwork R package to add a theme
# You can find more details in the 'advanced' tutorial
MapLabels(vis_mod_nmf, column_name = "anno",  pt_size = 1.8, pt_alpha = 1,  pt_stroke = NA, section_number = 1, ncol = 1) &
  theme(legend.position = "right")
```


Figure 4 has changed to reflect the cancer biology in the paper 
I am displaying deconvolution results and NMF
I am saving high res images as a PNG in Figure_5/deconv/

```{r}
deconv <- readRDS(file = paste0("/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/output/rds_objects/new_object/", "vis_mod_nmf_decon.rds"))
```

Starting plotting patient 4 - STAY

```{r width = 8, height = 6}
# Plot selected cell types

DefaultAssay(deconv) <- "garvan_major_map"
selected_celltypes <- c("B-cells")
p_Bcells_4515_hard <- lapply(seq_along(selected_celltypes), function(i) {
  MapFeatures(deconv, pt_size = 1.3,
            features = selected_celltypes[i], 
            colors = RColorBrewer::brewer.pal(n = 9, name = "Spectral") |> rev(),
            section_number = 8,
            max_cutoff = 0.99,
            #ncol = 4,
            override_plot_dims = TRUE) & 
  theme(plot.title = element_blank(), 
        legend.position = "right", legend.text = element_text(angle = 0))
}) |> setNames(nm = selected_celltypes)
print(p_Bcells_4515_hard)

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_5/deconv/p_Bcells_4515_hard.png", width = 8*png_res, height = 6*png_res, res = png_res);print(p_Bcells_4515_hard);dev.off()
```

```{r width = 8, height = 6}
#trying to map NMF
p_NMF10_4515_hard <- MapFeatures(deconv, 
            features = paste0("NMF_", 10),
            section_number = 8,
            override_plot_dims = TRUE, 
            pt_size = 1.3, 
            max_cutoff = 0.99,
            #alpha = 0.8,
            #scale = c("shared"),
            colors = viridis::magma(n = 11, direction = -1)) &
  theme(plot.title = element_blank(), 
        legend.position = "right", legend.text = element_text(angle = 0))
print(p_NMF10_4515_hard)

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_5/deconv/pNMF_10_4515_hard.png", width = 8*png_res, height = 6*png_res, res = png_res);print(p_NMF10_4515_hard);dev.off()
```

```{r width = 8, height = 6}
# Plot selected cell types

DefaultAssay(deconv) <- "garvan_major_map"
selected_celltypes <- c("Plasmablasts")
p_plasma_4515_hard <- lapply(seq_along(selected_celltypes), function(i) {
  MapFeatures(deconv, pt_size = 1.3,
            features = selected_celltypes[i], 
            colors = RColorBrewer::brewer.pal(n = 9, name = "Spectral") |> rev(),
            section_number = 8,
            max_cutoff = 0.99,
            #ncol = 4,
            override_plot_dims = TRUE) & 
  theme(plot.title = element_blank(), 
        legend.position = "right", legend.text = element_text(angle = 0))
}) |> setNames(nm = selected_celltypes)
print(p_plasma_4515_hard)

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_5/deconv/p_Plasmablasts_4515_hard.png", width = 8*png_res, height = 6*png_res, res = png_res);print(p_plasma_4515_hard);dev.off()
```

```{r width = 8, height = 6}
#trying to map NMF
p_NMF20_4515_hard <- MapFeatures(deconv, 
            features = paste0("NMF_", 20),
            section_number = 8,
            override_plot_dims = TRUE, 
            pt_size = 1.3, 
            max_cutoff = 0.99,
            #alpha = 0.8,
            #scale = c("shared"),
            colors = viridis::magma(n = 11, direction = -1)) &
  theme(plot.title = element_blank(), 
        legend.position = "right", legend.text = element_text(angle = 0))
print(p_NMF20_4515_hard)

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_5/deconv/pNMF_20_4515_hard.png", width = 8*png_res, height = 6*png_res, res = png_res);print(p_NMF20_4515_hard);dev.off()
```

```{r width = 8, height = 6}
# Plot selected cell types

DefaultAssay(deconv) <- "garvan_major_map"
selected_celltypes <- c("Myeloid")
p_myeloid_4515_hard <- lapply(seq_along(selected_celltypes), function(i) {
  MapFeatures(deconv, pt_size = 1.3,
            features = selected_celltypes[i], 
            colors = RColorBrewer::brewer.pal(n = 9, name = "Spectral") |> rev(),
            section_number = 8,
            max_cutoff = 0.99,
            #ncol = 4,
            override_plot_dims = TRUE) & 
  theme(plot.title = element_blank(), 
        legend.position = "right", legend.text = element_text(angle = 0))
}) |> setNames(nm = selected_celltypes)
print(p_myeloid_4515_hard)

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_5/deconv/p_Myeloid_4515_hard.png", width = 8*png_res, height = 6*png_res, res = png_res);print(p_myeloid_4515_hard);dev.off()
```

```{r width = 8, height = 6}
#trying to map NMF
p_NMF8_4515_hard <- MapFeatures(deconv, 
            features = paste0("NMF_", 8),
            section_number = 8,
            override_plot_dims = TRUE, 
            pt_size = 1.3, 
            max_cutoff = 0.99,
            #alpha = 0.8,
            #scale = c("shared"),
            colors = viridis::magma(n = 11, direction = -1)) &
  theme(plot.title = element_blank(), 
        legend.position = "right", legend.text = element_text(angle = 0))
print(p_NMF8_4515_hard)

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_5/deconv/pNMF_8_4515_hard.png", width = 8*png_res, height = 6*png_res, res = png_res);print(p_NMF8_4515_hard);dev.off()
```

Starting plotting patient 4 - standard

```{r}
#test for scale 0 to 1
selected_celltypes <- c("Plasmablasts")
test <- lapply(seq_along(selected_celltypes), function(i) {
  MapFeatures(deconv, pt_size = 1.3,
              features = selected_celltypes[i], 
              section_number = 8,
              max_cutoff = 0.99,
              override_plot_dims = TRUE) +  # use +, not &
    scale_fill_gradientn(
      colours = RColorBrewer::brewer.pal(n = 9, name = "Spectral") |> rev(),
      limits = c(0, 1),
      name = "Cell\nfraction"
    ) +
    theme(plot.title = element_blank(), 
          legend.position = "right",
          legend.text = element_text(angle = 0))
}) |> setNames(nm = selected_celltypes)

print(test)

```

```{r}
#test for scale 0 to 1
selected_celltypes <- c("Plasmablasts")
test <- lapply(seq_along(selected_celltypes), function(i) {
  MapFeatures(deconv, pt_size = 1.3,
              features = selected_celltypes[i], 
              section_number = 8,
              max_cutoff = 0.99,
              override_plot_dims = TRUE) +  # use +, not &
    scale_fill_gradientn(
      colours = RColorBrewer::brewer.pal(n = 9, name = "Spectral") |> rev(),
      limits = c(0, 1),
      name = "Cell\nfraction"
    ) +
    theme(plot.title = element_blank(), 
          legend.position = "right",
          legend.text = element_text(angle = 0))
}) |> setNames(nm = selected_celltypes)

print(test)

```


```{r}
library(ggplot2)

# Step 1: Get the global max of all factor values
max_nmf_value <- max(deconv@reductions$nmf@cell.embeddings)

# Step 2: Plot with consistent color scale
test_factor_soft<- MapFeatures(
  deconv, 
  features = "NMF_10",
  section_number = 7,
  override_plot_dims = TRUE, 
  pt_size = 1.3, 
  max_cutoff = 0.99,
  colors = viridis::magma(n = 11, direction = -1)
) & 
   scale_fill_gradientn(
    colors = viridis::magma(n = 11, direction = -1),
    limits = c(0, max_nmf_value),
    name = "Factor\nactivity"  # Or just name = NULL if you want to remove it
  ) & 
  theme(
    plot.title = element_blank(), 
    legend.position = "right",
    legend.text = element_text(angle = 0)
  )

# Optional: save to file
print(test_factor_soft)

```

```{r}
# Step 2: Plot with consistent color scale
test_factor_hard<- MapFeatures(
  deconv, 
  features = "NMF_10",
  section_number = 8,
  override_plot_dims = TRUE, 
  pt_size = 1.3, 
  max_cutoff = 0.99,
  #colors = viridis::magma(n = 11, direction = -1)
) & 
  scale_fill_gradientn(
    colors = viridis::magma(n = 11, direction = -1),
    limits = c(0, max_nmf_value),
    name = "Factor\nactivity"  # Or just name = NULL if you want to remove it
  ) & 
  theme(
    plot.title = element_blank(), 
    legend.position = "right",
    legend.text = element_text(angle = 0)
  )

# Optional: save to file
print(test_factor_hard)
```


```{r width = 8, height = 6}
# Plot selected cell types

DefaultAssay(deconv) <- "garvan_major_map"
selected_celltypes <- c("B-cells")
p_Bcells_4515_standard <- lapply(seq_along(selected_celltypes), function(i) {
  MapFeatures(deconv, pt_size = 1.3,
            features = selected_celltypes[i], 
            colors = RColorBrewer::brewer.pal(n = 9, name = "Spectral") |> rev(),
            section_number = 7,
            max_cutoff = 0.99,
            #ncol = 4,
            override_plot_dims = TRUE) & 
  theme(plot.title = element_blank(), 
        legend.position = "right", legend.text = element_text(angle = 0))
}) |> setNames(nm = selected_celltypes)
print(p_Bcells_4515_standard)

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_5/deconv/p_Bcells_4515_standard.png", width = 8*png_res, height = 6*png_res, res = png_res);print(p_Bcells_4515_standard);dev.off()
```

```{r width = 8, height = 6}
#trying to map NMF
p_NMF10_4515_standard <- MapFeatures(deconv, 
            features = paste0("NMF_", 10),
            section_number = 7,
            override_plot_dims = TRUE, 
            pt_size = 1.3, 
            max_cutoff = 0.99,
            #alpha = 0.8,
            #scale = c("shared"),
            colors = viridis::magma(n = 11, direction = -1)) &
  theme(plot.title = element_blank(), 
        legend.position = "right", legend.text = element_text(angle = 0))
print(p_NMF10_4515_standard)

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_5/deconv/pNMF_10_4515_standard.png", width = 8*png_res, height = 6*png_res, res = png_res);print(p_NMF10_4515_standard);dev.off()
```

```{r width = 8, height = 6}
# Plot selected cell types

DefaultAssay(deconv) <- "garvan_major_map"
selected_celltypes <- c("Plasmablasts")
p_plasma_4515_standard <- lapply(seq_along(selected_celltypes), function(i) {
  MapFeatures(deconv, pt_size = 1.3,
            features = selected_celltypes[i], 
            colors = RColorBrewer::brewer.pal(n = 9, name = "Spectral") |> rev(),
            section_number = 7,
            max_cutoff = 0.99,
            #ncol = 4,
            override_plot_dims = TRUE) & 
  theme(plot.title = element_blank(), 
        legend.position = "right", legend.text = element_text(angle = 0))
}) |> setNames(nm = selected_celltypes)
print(p_plasma_4515_standard)

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_5/deconv/p_Plasmablasts_4515_standard.png", width = 8*png_res, height = 6*png_res, res = png_res);print(p_plasma_4515_standard);dev.off()
```

```{r width = 8, height = 6}
#trying to map NMF
p_NMF20_4515_standard <- MapFeatures(deconv, 
            features = paste0("NMF_", 20),
            section_number = 7,
            override_plot_dims = TRUE, 
            pt_size = 1.3, 
            max_cutoff = 0.99,
            #alpha = 0.8,
            #scale = c("shared"),
            colors = viridis::magma(n = 11, direction = -1)) &
  theme(plot.title = element_blank(), 
        legend.position = "right", legend.text = element_text(angle = 0))
print(p_NMF20_4515_standard)

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_5/deconv/pNMF_20_4515_standard.png", width = 8*png_res, height = 6*png_res, res = png_res);print(p_NMF20_4515_standard);dev.off()
```

```{r width = 8, height = 6}
# Plot selected cell types

DefaultAssay(deconv) <- "garvan_major_map"
selected_celltypes <- c("Myeloid")
p_myeloid_4515_standard <- lapply(seq_along(selected_celltypes), function(i) {
  MapFeatures(deconv, pt_size = 1.3,
            features = selected_celltypes[i], 
            colors = RColorBrewer::brewer.pal(n = 9, name = "Spectral") |> rev(),
            section_number = 7,
            max_cutoff = 0.99,
            #ncol = 4,
            override_plot_dims = TRUE) & 
  theme(plot.title = element_blank(), 
        legend.position = "right", legend.text = element_text(angle = 0))
}) |> setNames(nm = selected_celltypes)
print(p_myeloid_4515_standard)

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_5/deconv/p_Myeloid_4515_standard.png", width = 8*png_res, height = 6*png_res, res = png_res);print(p_myeloid_4515_standard);dev.off()
```

```{r width = 8, height = 6}
#trying to map NMF
p_NMF8_4515_standard <- MapFeatures(deconv, 
            features = paste0("NMF_", 8),
            section_number = 7,
            override_plot_dims = TRUE, 
            pt_size = 1.3, 
            max_cutoff = 0.99,
            #alpha = 0.8,
            #scale = c("shared"),
            colors = viridis::magma(n = 11, direction = -1)) &
  theme(plot.title = element_blank(), 
        legend.position = "right", legend.text = element_text(angle = 0))
print(p_NMF8_4515_standard)

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_5/deconv/pNMF_8_4515_standard.png", width = 8*png_res, height = 6*png_res, res = png_res);print(p_NMF8_4515_standard);dev.off()
```
