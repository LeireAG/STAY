---
title: "figure_4"
Aim: investigating areas of detachment by Non-Negative Matrix factorization and deconvolution with the NNLS method
in Figure 4 to reflect the cancer biology in the paper 
I am displaying deconvolution results and NMF
---

```{r}
library(semla)
library(singlet)
library(ggplot2)
library(tidyverse)
library(dplyr)
```

1. Run NMF the normalized Seurat object but excluding reductions. 
```{r}
# Normalize data and find top variable features
vis_mod_norm <- vis_mod |> 
  NormalizeData() |> 
  FindVariableFeatures()
```

```{r}
## Run NMF
set.seed(42)
vis_mod_nmf <- RunNMF(vis_mod_norm, assay = "RNA3") #k = 20 (if I want exactly 20 factors)
```


```{r}
#### Save object
saveRDS(vis_mod_nmf,
        file = paste0("my_path/", "vis_mod_nmf.rds"))
```

2. Run deconvolution on this object using the semla deconvolution script save and load. 

```{r, eval = FALSE}
vis_mod_nmf <- readRDS(paste0("my_path/", "vis_mod_nmf_decon.rds"))
```

```{r}
#### Check optimal number of factors k
k <- ncol(vis_mod_nmf@reductions$nmf@feature.loadings)
k
```

```{r}
#### Print factorization rank
#pdf(paste0(plot.dir, "/RankPlot_nmf", ".pdf"), width = 25, height = 12)
print(RankPlot(vis_mod_nmf))
#dev.off()
```

```{r plot_NMF_features, fig.width=14, fig.height=15}
#Explore gene contributions to each factor
k <- ncol(deconv@reductions$nmf@feature.loadings)
k
p <- PlotFeatureLoadings(deconv, 
                    dims = 1:k, 
                    reduction = "nmf", 
                    nfeatures = 15,
                    mode = "dotplot", 
                    fill = "darkmagenta",
                    pt_size = 3,
                    ncols = 5)
p

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_5/new_corrected_object/nmf/vis_mod_NMF_feature_loading.png", width = 14*png_res, height = 25*png_res, res = png_res);print(p);dev.off()

#Generates Figure 4 B
p_10_11_21 <- PlotFeatureLoadings(deconv, 
                    dims = c(11, 21, 10), 
                    reduction = "nmf", 
                    nfeatures = 10,
                    mode = "dotplot", 
                    fill = "black",
                    pt_size = 3,
                    ncols = 3) &
     labs(x = "Gene name", y = "Gene contribution") &
     theme_minimal() &
     theme(panel.grid.major = element_blank(),
           panel.grid.minor = element_blank(),
           axis.line = element_line(colour = "black"))
p_10_11_21

png_res <- 1200
png(filename = "/my_path/deconv_feature_loading_selected_NMF.png", width = 8*png_res, height = 5*png_res, res = png_res);print(p_10_11_21);dev.off()

pdf(paste0("/my_path/", "/deconv_feature_loading_selected_NMF", ".pdf"), width = 10, height = 5)
print(p_10_11_21)
dev.off()

pdf(paste0("/my_path/", "/vis_mod_NMF_feature_loading", ".pdf"), width = 14, height = 15)
print(p)
dev.off()
```

Supplementary figure 11 and 12 <- # Visualize gene contributions (in heatmap divided in two)
```{r fig.width=14, fig.height=25}

p2 <- PlotFeatureLoadings(vis_mod_nmf, 
                    dims = 1:12, 
                    reduction = "nmf", 
                    nfeatures = 10, 
                    mode = "heatmap", 
                    gradient_colors = viridis::magma(n = 11, direction = -1))
p2

ggsave(paste0("/my_path/", "/gene_loadings_heatmap_NMF1_12", ".pdf"), plot = p2, width = 6.5, height = 11.6, dpi = 300)

p3 <- PlotFeatureLoadings(vis_mod_nmf, 
                    dims = 13:24, 
                    reduction = "nmf", 
                    nfeatures = 10, 
                    mode = "heatmap", 
                    gradient_colors = viridis::magma(n = 11, direction = -1))
p3

ggsave(paste0("/my_path/", "/gene_loadings_heatmap_NMF13_24", ".pdf"), plot = p3, width = 6.5, height = 11.6, dpi = 300)

```

Visualization of factors spatially for Supplementary figures 3 to 10

```{r plot_NMF, fig.width=14, fig.height=25}
pdf_clinical_id_1_STAY <- "/my_path/pdf_clinical_id_1_STAY.pdf"
pdf(file = pdf_clinical_id_1_STAY, width = 20, height = 30)
p1 <- MapFeatures(deconv, 
            section_number = 1,
            features = paste0("NMF_", 1:k), 
            override_plot_dims = TRUE, 
            ncol = 5,
            pt_size = 1,
            pt_stroke = NA,
            colors = viridis::magma(n = 11, direction = -1)) &
  theme(plot.title = element_blank())

print(p1)
dev.off()

png_res <- 1200
png(filename = "/my_path/clinical_id_1_STAY.png", width = 14*png_res, height = 25*png_res, res = png_res);print(p1);dev.off()
```

```{r plot_NMF, fig.width=14, fig.height=25}

p2 <- MapFeatures(deconv, 
            section_number = 2,
            features = paste0("NMF_", 1:k), 
            override_plot_dims = TRUE, 
            ncol = 5,
            pt_size = 1,
            pt_stroke = NA,
            colors = viridis::magma(n = 11, direction = -1)) &
  theme(plot.title = element_blank())

print(p2)

```

```{r plot_NMF, fig.width=14, fig.height=25}

p3 <- MapFeatures(deconv, 
            section_number = 3,
            features = paste0("NMF_", 1:k), 
            override_plot_dims = TRUE, 
            ncol = 5,
            pt_size = 1.3,
            pt_stroke = NA,
            colors = viridis::magma(n = 11, direction = -1)) &
  theme(plot.title = element_blank())

print(p3)

```


```{r plot_NMF, fig.width=14, fig.height=25}

p4 <- MapFeatures(deconv, 
            section_number = 4,
            features = paste0("NMF_", 1:k), 
            override_plot_dims = TRUE, 
            ncol = 5,
            pt_size = 1.3,
            pt_stroke = NA,
            colors = viridis::magma(n = 11, direction = -1)) &
  theme(plot.title = element_blank())

print(p4)

```

```{r plot_NMF, fig.width=14, fig.height=25}

p5 <- MapFeatures(deconv, 
            section_number = 5,
            features = paste0("NMF_", 1:k), 
            override_plot_dims = TRUE, 
            ncol = 5,
            pt_size = 1.3,
            pt_stroke = NA,
            colors = viridis::magma(n = 11, direction = -1)) &
  theme(plot.title = element_blank())

print(p5)

```

```{r plot_NMF, fig.width=14, fig.height=25}

p6 <- MapFeatures(deconv, 
            section_number = 6,
            features = paste0("NMF_", 1:k), 
            override_plot_dims = TRUE, 
            ncol = 5,
            pt_size = 1.3,
            pt_stroke = NA,
            colors = viridis::magma(n = 11, direction = -1)) &
  theme(plot.title = element_blank())

print(p6)

```

```{r plot_NMF, fig.width=14, fig.height=25}

p7 <- MapFeatures(deconv, 
            section_number = 7,
            features = paste0("NMF_", 1:k), 
            override_plot_dims = TRUE, 
            ncol = 5,
            pt_size = 1,
            pt_stroke = NA,
            colors = viridis::magma(n = 11, direction = -1)) &
  theme(plot.title = element_blank())

print(p7)

```

```{r plot_NMF, fig.width=14, fig.height=25}

p8 <- MapFeatures(deconv, 
            section_number = 8,
            features = paste0("NMF_", 1:k), 
            override_plot_dims = TRUE, 
            ncol = 5,
            pt_size = 1,
            pt_stroke = NA,
            colors = viridis::magma(n = 11, direction = -1)) &
  theme(plot.title = element_blank())

print(p8)

```


### plot celltypes over factors figure 4 A. 
```{r}
DefaultAssay(deconv) <- "garvan_major_map"
# Calculate Spearman correlation between NMF factors and cell types
nmf_matrix <- deconv@reductions$nmf@cell.embeddings
celltypes_major <- rownames(deconv@assays$garvan_major_map@data)
celltype_matrix <- FetchData(deconv, layer = "data", assay = DefaultAssay(deconv), vars = celltypes_major)
# Ensure both matrices have shared rownames
shared_rownames <- intersect(rownames(nmf_matrix), rownames(celltype_matrix))
nmf_matrix <- nmf_matrix[shared_rownames, , drop = FALSE]
celltype_matrix <- celltype_matrix[shared_rownames, , drop = FALSE]
correlation_matrix <- cor(nmf_matrix, celltype_matrix, method = "spearman")

library(heatmap3)

pdf("/my_path/nmf_major_celltype_correlation.pdf", width = 10, height = 10)
    heatmap3(correlation_matrix, 
    margins = c(12, 10))
dev.off()
```

Starting plotting for figure 4 D1-I1 and D2-I2
patient 4 - STAY

```{r width = 8, height = 6}
# Setp 1: Plot selected cell types
DefaultAssay(deconv) <- "garvan_major_map"
selected_celltypes <- c("B-cells")
# Step 2: Plot with consistent visible color scale
pastel_turbo <- adjustcolor(viridis::turbo(11), alpha.f = 1, red.f = 1.2, green.f = 1.2, blue.f = 1.2)

p_Bcells_patient4_STAY <- lapply(seq_along(selected_celltypes), function(i) {
  MapFeatures(deconv, pt_size = 1.3,
            features = selected_celltypes[i], 
            colors = RColorBrewer::brewer.pal(n = 9, name = "Spectral") |> rev(),
            section_number = 8,
            max_cutoff = 0.99,
            #ncol = 4,
            override_plot_dims = TRUE) + 
    scale_fill_gradientn(
      #colours = RColorBrewer::brewer.pal(n = 9, name = "Spectral") |> rev(),
      colours = pastel_turbo,
      limits = c(0, 1),
      name = "Cell\nfraction"
    ) +
    theme(plot.title = element_blank(), 
          legend.position = "right",
          legend.text = element_text(angle = 0))
}) |> setNames(nm = selected_celltypes)

```

```{r width = 8, height = 6}

# Map NMF
p_NMF11_patient4_STAY <- MapFeatures(deconv, 
            features = paste0("NMF_", 11),
            section_number = 8,
            override_plot_dims = TRUE, 
            pt_size = 1.3, 
            max_cutoff = 0.99,
            #alpha = 0.8,
            #scale = c("shared"),
            colors = viridis::magma(n = 11, direction = -1)) &
  scale_fill_gradientn(
    colors = viridis::magma(n = 11, direction = -1),
    #limits = c(0, max_nmf_value),
    name = "Factor\nactivity"  # Or just name = NULL if you want to remove it
  ) & 
  theme(
    plot.title = element_blank(), 
    legend.position = "right",
    legend.text = element_text(angle = 0)
  )

```

```{r width = 8, height = 6}
# Plot selected cell types

DefaultAssay(deconv) <- "garvan_major_map"
selected_celltypes <- c("Plasmablasts")
p_plasma_Patient4_STAY <- lapply(seq_along(selected_celltypes), function(i) {
  MapFeatures(deconv, pt_size = 1.3,
            features = selected_celltypes[i], 
            colors = RColorBrewer::brewer.pal(n = 9, name = "Spectral") |> rev(),
            section_number = 8,
            max_cutoff = 0.99,
            #ncol = 4,
            override_plot_dims = TRUE) + 
    scale_fill_gradientn(
      #colours = RColorBrewer::brewer.pal(n = 9, name = "Spectral") |> rev(),
      colors = pastel_turbo, 
      limits = c(0, 1),
      name = "Cell\nfraction"
    ) +
    theme(plot.title = element_blank(), 
          legend.position = "right",
          legend.text = element_text(angle = 0))
}) |> setNames(nm = selected_celltypes)

```

```{r width = 8, height = 6}
#trying to map NMF
p_NMF21_Patient4_STAY <- MapFeatures(deconv, 
            features = paste0("NMF_", 21),
            section_number = 8,
            override_plot_dims = TRUE, 
            pt_size = 1.3, 
            max_cutoff = 0.99,
            #alpha = 0.8,
            #scale = c("shared"),
            colors = viridis::magma(n = 11, direction = -1)) &
  scale_fill_gradientn(
    colors = viridis::magma(n = 11, direction = -1),
    #limits = c(0, max_nmf_value),
    name = "Factor\nactivity"  # Or just name = NULL if you want to remove it
  ) & 
  theme(
    plot.title = element_blank(), 
    legend.position = "right",
    legend.text = element_text(angle = 0)
  )

```

```{r width = 8, height = 6}
# Plot selected cell types

DefaultAssay(deconv) <- "garvan_major_map"
selected_celltypes <- c("Myeloid")
p_myeloid_Patient4_STAY <- lapply(seq_along(selected_celltypes), function(i) {
  MapFeatures(deconv, pt_size = 1.3,
            features = selected_celltypes[i], 
            colors = RColorBrewer::brewer.pal(n = 9, name = "Spectral") |> rev(),
            section_number = 8,
            max_cutoff = 0.99,
            #ncol = 4,
            override_plot_dims = TRUE) + 
    scale_fill_gradientn(
      #colours = RColorBrewer::brewer.pal(n = 9, name = "Spectral") |> rev(),
      colours = pastel_turbo,
      limits = c(0, 1),
      name = "Cell\nfraction"
    ) +
    theme(plot.title = element_blank(), 
          legend.position = "right",
          legend.text = element_text(angle = 0))
}) |> setNames(nm = selected_celltypes)

```

```{r width = 8, height = 6}
#trying to map NMF
p_NMF10_Patient4_STAY <- MapFeatures(deconv, 
            features = paste0("NMF_", 10),
            section_number = 8,
            override_plot_dims = TRUE, 
            pt_size = 1.3, 
            max_cutoff = 0.99,
            #alpha = 0.8,
            #scale = c("shared"),
            colors = viridis::magma(n = 11, direction = -1)) &
   scale_fill_gradientn(
    colors = viridis::magma(n = 11, direction = -1),
    #limits = c(0, max_nmf_value),
    name = "Factor\nactivity"  # Or just name = NULL if you want to remove it
  ) & 
  theme(
    plot.title = element_blank(), 
    legend.position = "right",
    legend.text = element_text(angle = 0)
  )

```

Starting plotting patient 4 - standard

```{r}
#test for scale 0 to 1
selected_celltypes <- c("B-cells")
p_Bcells_Patient4_stanadard <- lapply(seq_along(selected_celltypes), function(i) {
  MapFeatures(deconv, pt_size = 1.3,
              features = selected_celltypes[i], 
              section_number = 7,
              max_cutoff = 0.99,
              override_plot_dims = TRUE) +  # use +, not &
    scale_fill_gradientn(
      colours = pastel_turbo,
      limits = c(0, 1),
      name = "Cell\nfraction"
    ) +
    theme(plot.title = element_blank(), 
          legend.position = "right",
          legend.text = element_text(angle = 0))
}) |> setNames(nm = selected_celltypes)

```

```{r}
#test for scale 0 to 1
selected_celltypes <- c("Plasmablasts")
p_Plasmablast_Patient4_standard <- lapply(seq_along(selected_celltypes), function(i) {
  MapFeatures(deconv, pt_size = 1.3,
              features = selected_celltypes[i], 
              section_number = 7,
              max_cutoff = 0.99,
              override_plot_dims = TRUE) +  # use +, not &
    scale_fill_gradientn(
      #colours = RColorBrewer::brewer.pal(n = 9, name = "Spectral") |> rev(),
      colours = pastel_turbo,
      limits = c(0, 1),
      name = "Cell\nfraction"
    ) +
    theme(plot.title = element_blank(), 
          legend.position = "right",
          legend.text = element_text(angle = 0))
}) |> setNames(nm = selected_celltypes)

```


```{r width = 8, height = 6}
# Plot selected cell types

DefaultAssay(deconv) <- "garvan_major_map"
selected_celltypes <- c("B-cells")
p_Bcells_Patient4_standard <- lapply(seq_along(selected_celltypes), function(i) {
  MapFeatures(deconv, pt_size = 1.3,
            features = selected_celltypes[i], 
            colors = RColorBrewer::brewer.pal(n = 9, name = "Spectral") |> rev(),
            section_number = 7,
            max_cutoff = 0.99,
            #ncol = 4,
            override_plot_dims = TRUE) & 
  theme(plot.title = element_blank(), 
        legend.position = "right", legend.text = element_text(angle = 0))
}) |> setNames(nm = selected_celltypes)

```

```{r width = 8, height = 6}
#trying to map NMF
p_NMF11_Patient4_standard <- MapFeatures(deconv, 
            features = paste0("NMF_", 11),
            section_number = 7,
            override_plot_dims = TRUE, 
            pt_size = 1.3, 
            max_cutoff = 0.99,
            #alpha = 0.8,
            #scale = c("shared"),
            colors = viridis::magma(n = 11, direction = -1)) &
  theme(plot.title = element_blank(), 
        legend.position = "right", legend.text = element_text(angle = 0))

```

```{r width = 8, height = 6}
# Plot selected cell types

DefaultAssay(deconv) <- "garvan_major_map"
selected_celltypes <- c("Plasmablasts")
p_plasma_Patient4_standard <- lapply(seq_along(selected_celltypes), function(i) {
  MapFeatures(deconv, pt_size = 1.3,
            features = selected_celltypes[i], 
            colors = RColorBrewer::brewer.pal(n = 9, name = "Spectral") |> rev(),
            section_number = 7,
            max_cutoff = 0.99,
            #ncol = 4,
            override_plot_dims = TRUE) & 
  theme(plot.title = element_blank(), 
        legend.position = "right", legend.text = element_text(angle = 0))
}) |> setNames(nm = selected_celltypes)
print(p_plasma_4515_standard)

```

```{r width = 8, height = 6}
#trying to map NMF
p_NMF21_Patient4_standard <- MapFeatures(deconv, 
            features = paste0("NMF_", 21),
            section_number = 7,
            override_plot_dims = TRUE, 
            pt_size = 1.3, 
            max_cutoff = 0.99,
            #alpha = 0.8,
            #scale = c("shared"),
            colors = viridis::magma(n = 11, direction = -1)) &
  theme(plot.title = element_blank(), 
        legend.position = "right", legend.text = element_text(angle = 0))

```

```{r width = 8, height = 6}
# Plot selected cell types

DefaultAssay(deconv) <- "garvan_major_map"
selected_celltypes <- c("Myeloid")
p_myeloid_Patient4_standard <- lapply(seq_along(selected_celltypes), function(i) {
  MapFeatures(deconv, pt_size = 1.3,
            features = selected_celltypes[i], 
            colors = RColorBrewer::brewer.pal(n = 9, name = "Spectral") |> rev(),
            section_number = 7,
            max_cutoff = 0.99,
            #ncol = 4,
            override_plot_dims = TRUE) +  # use +, not &
    scale_fill_gradientn(
      colours = pastel_turbo,
      limits = c(0, 1),
      name = "Cell\nfraction"
    ) +
    theme(plot.title = element_blank(), 
          legend.position = "right",
          legend.text = element_text(angle = 0))
}) |> setNames(nm = selected_celltypes)


```


```{r width = 8, height = 6}
#trying to map NMF
p_NMF10_Patient4_standard <- MapFeatures(deconv, 
            features = paste0("NMF_", 10),
            section_number = 7,
            override_plot_dims = TRUE, 
            pt_size = 1.3, 
            max_cutoff = 0.99,
            #alpha = 0.8,
            #scale = c("shared"),
            colors = viridis::magma(n = 11, direction = -1)) &
  theme(plot.title = element_blank(), 
        legend.position = "right", legend.text = element_text(angle = 0))

```

```{r width = 8, height = 6}
# Plot selected cell types

DefaultAssay(deconv) <- "garvan_major_map"
selected_celltypes <- c("T-cells")
p_Tcells_Patient4_standard <- lapply(seq_along(selected_celltypes), function(i) {
  MapFeatures(deconv, pt_size = 1.3,
            features = selected_celltypes[i], 
            colors = RColorBrewer::brewer.pal(n = 9, name = "Spectral") |> rev(),
            section_number = 7,
            max_cutoff = 0.99,
            #ncol = 4,
            override_plot_dims = TRUE) +  # use +, not &
    scale_fill_gradientn(
      colours = pastel_turbo,
      limits = c(0, 1),
      name = "Cell\nfraction"
    ) +
    theme(plot.title = element_blank(), 
          legend.position = "right",
          legend.text = element_text(angle = 0))
}) |> setNames(nm = selected_celltypes)


```

