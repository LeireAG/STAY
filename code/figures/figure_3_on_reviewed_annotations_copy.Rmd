---
Aim: Comparison of the sensitivity of the standard vs. the STAY method. Using the object with the UPDATED annotations. 
---
Load packages 
```{r}
library(semla)
library(ggplot2)
library(tidyverse)
library(dplyr)
```

```{r}
#Normalize Seurat object with the updated annotations to account for differences in sequencing saturation
vis_mod_norm <- vis_mod |>
  NormalizeData() |>
  ScaleData()
```
Load normalized Seurat object 
```{r}
# Load data (new Seurat object modified by Sophie) with my added annotations
vis_mod_norm <- readRDS(file = paste0("/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/output/rds_objects/new_object/", "vis_mod_norm.rds"))
```

#Figure 3) A-H. Spatial plots of normalized unique genes per spot
```{r width = 8, height = 6}
#use magma color and no background images to reflect data loss due to tissue detachment. 

pdf_path_small <- "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/output/geneplot/small_samples_purple_plot.pdf"
pdf_path_large <- "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/output/geneplot/large_samples_purple_plot.pdf"


# Plot small capture area samples (6.5x6.5mm) with a larger point size
pdf(file = pdf_path_small, width = 8, height = 6)

p_small <- MapFeatures(vis_mod_norm,
                       features = "nFeature_Spatial",
                       colors = viridis::magma(n = 11, direction = -1),
                       slot = "counts",
                       override_plot_dims = FALSE,
                       #image_use = "raw",
                       pt_size = 0.5,  # Larger spot size for small capture areas
                       add_scalebar = T, scalebar_position = c(1,1),
                       pt_stroke = NA, # No stroke around spots
                       ncol = 4)
print(p_small)
dev.off()
png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_4/small_samples_plot_purple.png", width = 8*png_res, height = 6*png_res, res = png_res);print(p_small);dev.off()

#Plot large area samples (11x11mm) with a smaller point size
pdf(file = pdf_path_large, width = 8, height = 6)
p_large <- MapFeatures(vis_mod_norm,
                       features = "nFeature_Spatial",
                       colors = viridis::magma(n = 11, direction = -1),, 
                       slot = "counts",
                       override_plot_dims = TRUE,
                       #image_use = "raw",
                       pt_size = 0.3,  # Smaller spot size for large capture areas
                       pt_stroke = NA, # No stroke around spots
                       ncol = 4, 
                       add_scalebar = T, scalebar_position = c(1,1))
dev.off()

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/figures/2nd_draft/Figure_4/large_samples_plot_purple.png", width = 8*png_res, height = 6*png_res, res = png_res);print(p_large);dev.off()

```

Plot QC results
Figure 3I) corresponds to the distribution of unique genes between adjacent sections prepared with the standard or the STAY protocol
```{r, fig.width = 15, fig.height = 8}
feats <- c("nFeature_Spatial", "nCount_Spatial", "percent.mito", "percent.hemo", "percent.plat")
QC_all_samples <- VlnPlot(vis_mod_norm, group.by = "sample_id", split.by = "method", features = feats, pt.size = 0.1, ncol = 5)
```

Violin plots per layer 
We chose the epithelial to compare the sensitivity between methods as usually epithelial areas remained intact in both standard and STAY methods. The comparison has its limitations (e.g. path annotation is not exactly the same in adjacent sections, the selected area in Patient 4 with the STAY is slightly sifthed compared to the standard method) 


```{r}
# Subset based on the annotation using an expession
vis_mod_epithelial <- SubsetSTData(vis_mod, expression = Epithelial_Anno %in% c("invasive", "in_situ", "normal"))
```

```{r}
# Now, plot.df1 will contain the metadata with epithelial anno, method, and sample_id columns as factors, alongside the newly created log_nCount column. Used this plot.df1 data frame for plotting or further analysis.
plot.df1 <- vis_mod_epithelial@meta.data %>% 
  mutate(
    log_nCount = log1p(nCount_Spatial),
    Epithelial_Anno = as.factor(Epithelial_Anno),
    method = as.factor(method),
    sample_id = as.factor(sample_id)
  )
#str(plot.df1): Displays the structure of plot.df1, showing each column's name, data type (e.g., factor, numeric, etc.), and a preview of its values.
```

```{r} 
#Generates figure 3K. 
p <- ggplot(vis_mod_epithelial@meta.data, aes(y = nCount_Spatial, x = sample_id, fill = method)) +
  geom_violin(trim = FALSE, scale = "width") +
  scale_y_log10() +
  labs(title = "Log-transformed UMI Count Distribution in Epithelial Layer",
       x = "Sample ID",
       y = "Log-transformed UMI Count") +
  geom_boxplot(width = 0.1, outlier.shape = NA) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print(p)

```

#```{r}
# Filter the data to include only one block and using grouped annotations
 # plot.df.4515 <- plot.df1.group %>% 
  #filter(block_id %in% c("4515_4L_R1L")) # Focus on block 4515
# Plot the data using the filtered grouped annotations for all sections
#ggplot(plot.df.4515, aes(x = grouped_annotation, y = nCount_Spatial, fill = method)) +
  #geom_violin(trim = FALSE, scale = "width", width = 0.7) +  
  #facet_wrap(~ block_id, ncol = 2) +  # Facet by block_id
  #scale_y_log10() +  # Log-transform y-axis
  #theme_minimal() +  # Clean up the plot appearance
  #labs(title = "Comparison of UMI Counts by Annotation and Method",
       #y = "UMI Counts", x = "Annotation") +
  #theme(
    #plot.title = element_text(hjust = 0.5, size = 16),  # Increase title size
    #axis.title = element_text(size = 14),  # Increase axis title size
    #axis.text.x = element_text(angle = 45, hjust = 1, size = 10),  # Rotate x-axis labels and increase size
    #axis.text.y = element_text(size = 12),  # Increase y-axis text size
    #legend.position = "right",  # Position legend on the right
    #strip.text = element_text(size = 14)  # Increase facet label size
  #) 
#```

Can I extract the nb of UMIs per section from the normalized Seurat object, then am I accounting for the # seq depth? Total UMIs vs epithelial UMIs. YES!

```{r}
#library(dplyr)

# Example: Get total UMI count per section
vis_mod_norm@meta.data %>%
  group_by(sample_id) %>%
  summarize(median_UMI = median(nCount_Spatial),
            mean_UMI = mean(nCount_Spatial))

```

```{r}
#library(stringr)
vis_mod_norm@meta.data %>%
  filter(Epithelial_Anno %in% c("in_situ", "invasive", "normal")) %>%
  group_by(sample_id) %>%
  summarize(median_epithelial_UMI = median(nCount_Spatial))
```

Join both tables 

```{r}
# Get average UMI counts for epithelial spots per sample
epithelial_umi_stats <- vis_mod_norm@meta.data %>%
  filter(Epithelial_Anno %in% c("in_situ", "invasive", "normal")) %>%
  group_by(sample_id) %>%
  summarize(
    mean_epithelial_UMI = mean(nCount_Spatial),
    median_epithelial_UMI = median(nCount_Spatial),
    spot_count = n()
  )
#Compare to total UMI counts per sample
total_umi_stats <- vis_mod_norm@meta.data %>%
  group_by(sample_id) %>%
  summarize(
    mean_total_UMI = mean(nCount_Spatial),
    median_total_UMI = median(nCount_Spatial),
    total_spots = n()
  )
#join both tables
comparison <- left_join(total_umi_stats, epithelial_umi_stats, by = "sample_id")
print(comparison)
```

Addressing data loss 
```{r}
#Visualize data loss directly plotting the number of spots with non-zero counts for each method. On filtered matrix!
vis_mod_norm@meta.data %>% 
  group_by(method) %>% 
  summarise(non_zero_spots = sum(nCount_Spatial > 0)) %>% 
  ggplot(aes(x = method, y = non_zero_spots, fill = method)) +
  geom_bar(stat = "identity") +
  labs(x = "sample_id", y = "Number of Spots with Data", title = "Data Loss Comparison by Method") +
  theme_minimal()
```

Can I have a look in all samples? This generates figure 3) J. 
```{r width = 10, height = 8}
#vis_mod_norm@meta.data %>%
spots_by_method <- vis_mod_anno@meta.data %>%  
  group_by(patient, method) %>%
  summarise(non_zero_spots = sum(nCount_Spatial > 0)) %>%
  ggplot(aes(x = patient, y = non_zero_spots, fill = method)) +
  # Bar plot with custom width and dodge
  geom_bar(stat = "identity", position = position_dodge(width = 0.6), width = 0.6) +
  # Text labels on top of bars
  geom_text(aes(label = non_zero_spots),
            position = position_dodge(width = 0.6),
            vjust = -1,
            angle = 0,
            size = 3,
            family = "Helvetica") +
  labs(x = "Sample", y = "Number of Spots with Data", title = "Data Loss by Sample and Method") +
  # Color settings
  scale_fill_manual(values = c("STAY" = "#FBB4AE",  # pastel red
                             "standard" = "#B3CDE3")) + # pastel blue
    # Reduces padding between patient groups
  scale_x_discrete(expand = expansion(add = c(-0.1, -0.1))) +
  # Theme and font customization
  theme_minimal(base_family = "Helvetica") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    text = element_text(family = "Helvetica"),
    panel.spacing.x = unit(0.1, "lines"),  # optional: tighten facet spacing if faceted
    plot.margin = margin(1, 1, 1, 1),        # reduce whitespace around the plot
    panel.grid.major = element_blank(),   # removes major grid lines
    panel.grid.minor = element_blank()    # removes minor grid lines
  )
print (spots_by_method)

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/results_LA/updated_reworked_annotations/spots_by_method.png", width = 10*png_res, height = 8*png_res, res = png_res);print(spots_by_method);dev.off()
```

Yay! Save as PNG 
```{r}
png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/results_LA/Data_loss_across_method.png", width = 15*png_res, height = 8*png_res, res = png_res);print(QC_all_samples);dev.off()
```

Violin plot of unique genes
```{r, fig.width = 10, fig.height = 8}
unique_genesVplot <- VlnPlot(
  vis_mod_anno,
  group.by = "patient",
  split.by = "method",
  features = "nFeature_Spatial",
  pt.size = 0.1, 
  add = TRUE, 
  slot = "counts") +  
  scale_fill_manual(values = c("STAY" = "#FBB4AE",  # pastel red
                             "standard" = "#B3CDE3")) + # pastel blue 
  theme_minimal()
# This removes original points and adds new ones in grey
unique_genesVplot$layers[[2]] <- NULL  # remove original jittered points

unique_genesVplot <- unique_genesVplot + geom_boxplot(
  width = 0.1,
  outlier.shape = NA,
  position = position_dodge(width = 0.9),
  alpha = 0.7,
  color = "black",
  linewidth = 0.3
)

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/results_LA/updated_reworked_annotations/unique_genes_by_method.png", width = 10*png_res, height = 8*png_res, res = png_res);print(unique_genesVplot);dev.off()

```

Violin plot of unique genes
```{r, fig.width = 10, fig.height = 8}
DefaultAssay(deconv) <- "Spatial"
unique_genesVplot <- VlnPlot(
  deconv,
  group.by = "patient",
  split.by = "method",
  features = "nFeature_Spatial",
  pt.size = 0.1, 
  add = TRUE, 
  slot = "counts") +  
  scale_fill_manual(values = c("STAY" = "#FBB4AE",  # pastel red
                             "standard" = "#B3CDE3")) + # pastel blue 
  theme_minimal()
# This removes original points and adds new ones in grey
unique_genesVplot$layers[[2]] <- NULL  # remove original jittered points

unique_genesVplot <- unique_genesVplot + geom_boxplot(
  width = 0.1,
  outlier.shape = NA,
  position = position_dodge(width = 0.9),
  alpha = 0.7,
  color = "black",
  linewidth = 0.3
)

#Compare to total UMI counts per sample
total_umi_stats <- deconv@meta.data %>%
  group_by(sample_id) %>%
  summarize(
    mean_total_UMI = mean(nCount_Spatial),
    median_total_UMI = median(nCount_Spatial),
    total_spots = n()
  )


```
