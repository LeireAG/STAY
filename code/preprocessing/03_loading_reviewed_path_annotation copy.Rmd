# Aim: Now I am adding the reworked_annotations_alternative to the vis_mod object. 
At least here I won't have mixed annotations in the same layer but between layers. I am gonna process each annotation layer separately. This way I can isolate the specific annotation in a layer and correspoding spots (eg. epithelial invasive) to do pairwise comparisons. 

Note Sandra reviewed the annotations in Aug Sept 2024 and I am loading those in this script "reviewed_path_annotation"

```{r}
# Load packages
library(semla)
library(ggplot2)
library(tidyverse)
library(dplyr)
```

Load vis_mod object 
```{r}
# Load data (Seurat object with corrected image size)
vis_mod <- readRDS(file = paste0("/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/output/rds_objects/", "all_samples_cropped_img.rds"))
```

```{r}
# Create a data frame mapping section_id to Patient_ID and Method
id_map <- data.frame(
  section_id = c("4335_3D_R1L_s2", "4335_3D_R1L_s1",  # Patient 1: standard first
                 "4393_2H_R1S", "4393_2H_R1S_rep",     # Patient 2: standard, STAY
                 "4419_3F_R1S", "4419_3F_R1S_rep",     # Patient 3: standard, STAY
                 "4515_4L_R1L", "4515_4L_R1L_rep"),    # Patient 4: standard, STAY
  patient = c("Patient_1", "Patient_1", 
              "Patient_2", "Patient_2", 
              "Patient_3", "Patient_3", 
              "Patient_4", "Patient_4"),
  method = c("standard", "STAY", 
             "standard", "STAY", 
             "standard", "STAY", 
             "standard", "STAY")
)

# Add patient and method to metadata by matching sample_id
vis_mod@meta.data$patient <- id_map$patient[match(vis_mod@meta.data$sample_id, id_map$section_id)]
vis_mod@meta.data$method <- id_map$method[match(vis_mod@meta.data$sample_id, id_map$section_id)]

# Create a unified label
vis_mod@meta.data$patient_method <- paste0(vis_mod@meta.data$patient, "_", vis_mod@meta.data$method)

# Ensure consistent factor ordering for section_id
vis_mod@meta.data$sample_id <- factor(
  vis_mod@meta.data$sample_id,
  levels = id_map$section_id
)

# Check if order is consistent
table(vis_mod@meta.data$sample_id, vis_mod@meta.data$method)

```

```{r}
#Load annotations
load_annotations <- function(layer_name) {
  # List directories where annotation files are stored
  dirs <- list.dirs("/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/hard_vs_soft_coverslip/results/path_annotations/reworked_annotations",
                    recursive = FALSE, full.names = TRUE)
  
  # Process annotations for each sample section
  anno.df <- map_dfr(unique(vis_mod$sample_id), function(id) {
    # Find annotation files matching the current sample and layer
    fs <- list.files(str_subset(dirs, pattern = paste0(id, "$")), 
                     pattern = paste0(layer_name, "_reworked.csv"),  # Match specific layer
                     full.names = TRUE, recursive = TRUE)
    
    # Read annotation file (assumes one file per sample per layer)
    if (length(fs) == 0) {
      return(NULL)  # Skip if no file found
    }
    
    anno_df <- read_csv(fs)
    
    # Ensure consistent column names
    colnames(anno_df) <- c("barcode", "annotation")  # Adjust if needed
    
    # Adjust barcode suffix to match vis_mod
    suf <- which(unique(vis_mod$sample_id) == id)
    anno_df <- anno_df %>%
      mutate(barcode = str_replace(barcode, "\\d+$", as.character(suf)))
    
    return(anno_df)
  })
  
  return(anno.df)
}

```

```{r}
# Load each annotation layer separately
epithelial_annotations <- load_annotations("epithelial")
immune_annotations <- load_annotations("immune")
stroma_annotations <- load_annotations("stroma")
additional_annotations <- load_annotations("additional_features")
```

```{r}
# Add epithelial annotations
vis_mod <- AddMetaData(
  vis_mod,
  epithelial_annotations %>%
    select(barcode, annotation) %>%
    distinct() %>%  # Make sure there are no duplicates
    column_to_rownames("barcode"),
  col.name = "Epithelial_Anno"
)

# Add immune annotations
vis_mod <- AddMetaData(
  vis_mod,
  immune_annotations %>%
    select(barcode, annotation) %>%
    distinct() %>%
    column_to_rownames("barcode"),
  col.name = "Immune_Anno"
)

# Add stroma annotations
vis_mod <- AddMetaData(
  vis_mod,
  stroma_annotations %>%
    select(barcode, annotation) %>%
    distinct() %>%
    column_to_rownames("barcode"),
  col.name = "Stroma_Anno"
)

# Add additional annotations
vis_mod <- AddMetaData(
  vis_mod,
  additional_annotations %>%
    select(barcode, annotation) %>%
    distinct() %>%
    column_to_rownames("barcode"),
  col.name = "Additional_Anno"
)

```

```{r, width = 15, height = 8}
#Plot annotations to check how it looks spatially
epithelial_overview <- MapLabels(vis_mod, column_name = "Epithelial_Anno", ncol = 4) &
  theme(legend.position = "right")

stroma_overview <- MapLabels(vis_mod, column_name = "Stroma_Anno", ncol = 4) &
  theme(legend.position = "right")

immune_overview <- MapLabels(vis_mod, column_name = "Immune_Anno", ncol = 4) &
  theme(legend.position = "right")

additional_overview <- MapLabels(vis_mod, column_name = "Additional_Anno", ncol = 4) &
  theme(legend.position = "right")

```


```{r}
png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/results_LA/updated_reworked_annotations/epithelial_overview.png", width = 15*png_res, height = 8*png_res, res = png_res);print(epithelial_overview);dev.off()

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/results_LA/updated_reworked_annotations/immune_overview.png", width = 15*png_res, height = 8*png_res, res = png_res);print(immune_overview);dev.off()

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/results_LA/updated_reworked_annotations/stroma_overview.png", width = 15*png_res, height = 8*png_res, res = png_res);print(stroma_overview);dev.off()

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/results_LA/updated_reworked_annotations/additional_overview.png", width = 15*png_res, height = 8*png_res, res = png_res);print(additional_overview);dev.off()
```


```{r}
#save Seurat object with loaded UPDATED annotations, UPDATED patients IDs and UPDATED methods 
saveRDS(vis_mod,
        file = paste0("/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/output/rds_objects/", "vis_mod_anno.rds"))
```

```{r}
vis_mod_anno <- readRDS(paste0("/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/output/rds_objects/", "vis_mod_anno.rds"))
```

Preparing spot annotation for Figure 1 
```{r}
# Let's make the annotation plots for Figure 1 with the UPDATED annotations. For simplicity we will label desmoplastic stroma as NA and relabel as "epithelial" everything that is not fibrous or adipose stroma. 

#Renaming desmoplastic stroma as epithelial
vis_mod_anno@meta.data <- vis_mod_anno@meta.data %>%
  mutate(Stroma_Anno = ifelse(Stroma_Anno %in% c("adipose", "fibrous"),
                              Stroma_Anno,
                              "epithelial"))

annotation_colors <- c(
  "adipose" = "#ffe119",    # yellow
  "fibrous" = "#46f0f0",    # blue
  "epithelial" = "#f58231"  # orange
)
# Here we use the & operator from the patchwork R package to add a theme
# You can find more details in the 'advanced' tutorial

section_8 <- MapLabels(vis_mod_anno, column_name = "Stroma_Anno", colors = annotation_colors, pt_size = 1.3, pt_alpha = 1, section_number = 8, ncol = 1) & #Section_number 8 corresponds to the Patient 4 prepared with the STAY method. 
  theme(legend.position = "right")

print(section_8)

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/results_LA/updated_reworked_annotations/section_8_spot_annotation.png", width = 15*png_res, height = 8*png_res, res = png_res);print(section_8);dev.off()

#The same can be done with the Epithelial_Anno and Immune_Anno. The immune and epithelial layers stored in the metadata in the Seurat object. 
```

```{r}
# Here we use the & operator from the patchwork R package to add a theme
# You can find more details in the 'advanced' tutorial
section_7 <- MapLabels(vis_mod_anno, column_name = "Stroma_Anno", pt_size = 1.3, pt_alpha = 1, colors = annotation_colors, section_number = 7, ncol = 1) &
  theme(legend.position = "right")

print(section_7)

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/results_LA/updated_reworked_annotations/section_7_spot_annotation.png", width = 15*png_res, height = 8*png_res, res = png_res);print(section_7);dev.off()
```

```{r}
section_1 <- MapLabels(vis_mod_anno, column_name = "Stroma_Anno", pt_size = 1.3, pt_alpha = 1, colors = annotation_colors, section_number = 1, ncol = 1) &
  theme(legend.position = "right")

print(section_1)

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/results_LA/updated_reworked_annotations/section_1_spot_annotation.png", width = 15*png_res, height = 8*png_res, res = png_res);print(section_1);dev.off()
```

```{r}
section_2 <- MapLabels(vis_mod_anno, column_name = "Stroma_Anno", pt_size = 1.3, pt_alpha = 1, colors = annotation_colors, section_number = 2, ncol = 1) &
  theme(legend.position = "right")
print(section_2)

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/results_LA/updated_reworked_annotations/section_2_spot_annotation.png", width = 15*png_res, height = 8*png_res, res = png_res);print(section_2);dev.off()
```
```{r}
section_3 <- MapLabels(vis_mod_anno, column_name = "Stroma_Anno", colors = annotation_colors, pt_size = 2, pt_alpha = 1, section_number = 3, ncol = 1) &
  theme(legend.position = "right")

print(section_3)

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/results_LA/updated_reworked_annotations/section_3_spot_annotation.png", width = 15*png_res, height = 8*png_res, res = png_res);print(section_3);dev.off()

```

```{r}
section_4 <- MapLabels(vis_mod_anno, column_name = "Stroma_Anno", pt_size = 2, pt_alpha = 1, colors = annotation_colors, section_number = 4, ncol = 1) &
  theme(legend.position = "right")

print(section_4)

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/results_LA/updated_reworked_annotations/section_4_spot_annotation.png", width = 15*png_res, height = 8*png_res, res = png_res);print(section_4);dev.off()
```

```{r}
section_5 <- MapLabels(vis_mod_anno, column_name = "Stroma_Anno", pt_size = 2, pt_alpha = 1, colors = annotation_colors, section_number = 5, ncol = 1) &
  theme(legend.position = "right")

print(section_5)

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/results_LA/updated_reworked_annotations/section_5_spot_annotation.png", width = 15*png_res, height = 8*png_res, res = png_res);print(section_5);dev.off()
```

```{r}
section_6 <- MapLabels(vis_mod_anno, column_name = "Stroma_Anno", pt_size = 2, pt_alpha = 1, colors = annotation_colors, section_number = 6, ncol = 1) &
  theme(legend.position = "right")
print(section_6)

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/results_LA/updated_reworked_annotations/section_6_spot_annotation.png", width = 15*png_res, height = 8*png_res, res = png_res);print(section_6);dev.off()

```


```{r}
# Plot the H&E image for athe object
ImagePlot(vis_mod)
```

```{r}
#save Seurat object with loaded UPDATED annotations, UPDATED patients IDs and UPDATED methods 
saveRDS(vis_mod,
        file = paste0("/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/output/rds_objects/", "vis_mod_anno.rds"))
```


Load vis_mod object 
```{r}
# Load data (new Seurat object modified by Sophie) with my added annotations
vis_mod <- readRDS(file = paste0("/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/output/rds_objects/", "vis_mod_anno.rds"))
```


Violin plots per layer Figure 3
Epithelial 

```{r}
vis_mod_anno <- readRDS(paste0("/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/output/rds_objects/", "vis_mod_anno.rds"))
```

```{r}
# Subset based on the annotation using an expession for all spots annotated I have not only invasive, in situ and normal spots but also bening. 
vis_mod_epithelial <- SubsetSTData(vis_mod_anno, expression = Epithelial_Anno %in% c("invasive", "in_situ", "normal", "benign"))
```

```{r}
# Now, plot.df1 will contain the metadata with epithelial anno, method, and sample_id columns as factors, alongside the newly created log_nCount column. You can then use this plot.df1 data frame for plotting or further analysis.
plot.df1 <- vis_mod_epithelial@meta.data %>% 
  mutate(
    log_nCount = log1p(nCount_Spatial), #normilizing using log1p handles the slightly different sequencing saturation between samples
    Epithelial_Anno = as.factor(Epithelial_Anno),
    method = as.factor(method),
    patient = as.factor(patient) #replace sample_id with patient
  )
#str(plot.df1): Displays the structure of plot.df1, showing each column's name, data type (e.g., factor, numeric, etc.), and a preview of its values.
```

```{r fig.width=10, fig.height=8}
p_epithelial <- ggplot(plot.df1, aes(y = log_nCount, x = patient, fill = method)) +
  geom_violin(trim = FALSE, scale = "width", width = 1) +
  #geom_jitter(shape = 21, color = "grey40", size = 1, alpha = 1, position = position_dodge(width = 1)) +
  #stat_summary(fun = mean, geom = "point", shape = 23, size = 2, fill = "white", position = position_dodge(width = 1)) +
  scale_y_log10() +
  labs(title = "Log-transformed UMI Count Distribution in Epithelial Layer",
       x = "Patient",
       y = "Log-transformed UMI Count") +
  geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 1)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("STAY" = "#FBB4AE",  # pastel red
                             "standard" = "#B3CDE3"))  # pastel blue

print(p_epithelial)

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/results_LA/updated_reworked_annotations/epithelial_comparison.png", width = 10*png_res, height = 8*png_res, res = png_res);print(p_epithelial);dev.off()

```

```{r}
# Subset Seurat object
vis_mod_immune <- SubsetSTData(vis_mod_anno, expression = Immune_Anno %in% c("lymphocytes_aggregate", "lymphocytes_high", "lymphocytes_low"))

# Prepare metadata
plot.df_immune <- vis_mod_immune@meta.data %>%
  mutate(
    log_nCount = log1p(nCount_Spatial),
    Immune_Anno = as.factor(Immune_Anno),
    method = as.factor(method),
    patient = as.factor(patient)
  )

# Plot
p_immune <- ggplot(plot.df_immune, aes(y = log_nCount, x = patient, fill = method)) +
  geom_violin(trim = FALSE, scale = "width", width = 1) +
  geom_boxplot(width = 0.2, outlier.shape = NA, position = position_dodge(width = 1)) +
  labs(title = "Log-transformed UMI Count Distribution in Immune Layer",
       x = "Patient", y = "Log-transformed UMI Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
print(p_immune)

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/results_LA/updated_reworked_annotations/immune_comparison.png", width = 15*png_res, height = 8*png_res, res = png_res);print(p_immune);dev.off()
```

```{r fig.width=10, fig.height=8}
vis_mod_stroma <- SubsetSTData(deconv, expression = Stroma_Anno %in% c("adipose", "desmoplastic", "fibrous"))

plot.df_stroma <- vis_mod_stroma@meta.data %>%
  mutate(
    log_nCount = log1p(nCount_Spatial),
    Stroma_Anno = as.factor(Stroma_Anno),
    method = as.factor(method),
    patient = as.factor(patient)
  )

p_stroma <- ggplot(plot.df_stroma, aes(y = log_nCount, x = patient, fill = method)) +
  geom_violin(trim = FALSE, scale = "width", width = 1) +
  geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 1)) +
  labs(title = "Log-transformed UMI Count Distribution in Stroma Layer",
       x = "Patient", y = "Log-transformed UMI Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("STAY" = "#FBB4AE",  # pastel red
                             "standard" = "#B3CDE3"))  # pastel blue

print(p_stroma)

png_res <- 1200
png(filename = "/Users/leirealonso/Documents/ST/Project_Garvan_institute/Human_Breast_Cancer_Atlas/hard_vs_soft_cover/for_manuscripts/analysis/results_LA/updated_reworked_annotations/stroma_comparison.png", width = 10*png_res, height = 8*png_res, res = png_res);print(p_stroma);dev.off()
```

```{r}
p <- ggplot(vis_mod_epithelial@meta.data, aes(x = patient, fill = method)) +
  geom_bar(position = "dodge") +
  labs(title = "Spot Counts per Patient and Method", y = "Number of Spots") +
  theme_minimal()

```


Now I need to check the counts in the updated epithelial layer. Would be also good to compare the stroma layer. 

```{r}
#library(dplyr)

# Example: Get total UMI count per section
vis_mod_anno@meta.data %>%
  group_by(sample_id) %>%
  summarize(median_UMI = median(nCount_Spatial),
            mean_UMI = mean(nCount_Spatial))

```

```{r}
#library(stringr)
vis_mod@meta.data %>%
  filter(Epithelial_Anno %in% c("in_situ", "invasive", "normal", "benign")) %>%
  group_by(sample_id) %>%
  summarize(median_epithelial_UMI = median(nCount_Spatial))
```

```{r}
vis_mod_anno@meta.data %>%
  filter(Stroma_Anno %in% c("adipose", "desmoplastic", "fibrous")) %>%
  group_by(sample_id) %>%
  summarize(median_stroma_UMI = median(nCount_Spatial)
  )
```

```{r}
#Nb of adipose spots
vis_mod_anno@meta.data %>%
  filter(Stroma_Anno == "adipose") %>%
  group_by(sample_id) %>%
  summarise(n_adipose_spots = n()) %>%
  arrange(factor(sample_id, levels = unique(vis_mod_anno$sample_id)))

```
```{r}
#Nb of adipose spots
vis_mod_anno@meta.data %>%
  filter(Stroma_Anno == "fibrous") %>%
  group_by(sample_id) %>%
  summarise(n_fibrous_spots = n()) %>%
  arrange(factor(sample_id, levels = unique(vis_mod_anno$sample_id)))

```

```{r}
vis_mod@meta.data %>%
  filter(Immune_Anno %in% c("lymphocytes_aggregate", "lymphocytes_high", "lymphocytes_low")) %>%
  group_by(sample_id) %>%
  summarize(median_stroma_UMI = median(nCount_Spatial)
  )
```

Join both tables to make Supplementary Data 1

```{r}
# Get average UMI counts for epithelial spots per sample
epithelial_umi_stats <- vis_mod_anno@meta.data %>%
  filter(Epithelial_Anno %in% c("in_situ", "invasive", "normal", "benign")) %>%
  group_by(sample_id) %>%
  summarize(
    mean_epithelial_UMI = mean(nCount_Spatial),
    median_epithelial_UMI = median(nCount_Spatial),
    epithelial_spot = n()
  )
print(epithelial_umi_stats)

stroma_umi_stats <- vis_mod_anno@meta.data %>%
  filter(Stroma_Anno %in% c("adipose", "desmoplastic", "fibrous")) %>%
  group_by(sample_id) %>%
  summarize(
    mean_stroma_UMI = mean(nCount_Spatial),
    median_stroma_UMI = median(nCount_Spatial),
    stroma_spots = n(),
    adipose_spots = sum(Stroma_Anno == "adipose"),
    fibrous_spots = sum(Stroma_Anno == "fibrous")
  )
print(stroma_umi_stats)

immune_umi_stats <- vis_mod_anno@meta.data %>%
  filter(Immune_Anno %in% c("lymphocytes_aggregate", "lymphocytes_high", "lymphocytes_low")) %>%
  group_by(sample_id) %>%
  summarize(
    mean_immune_UMI = mean(nCount_Spatial),
    median_immune_UMI = median(nCount_Spatial),
    immune_spots = n()
  )
print(immune_umi_stats)

#Compare to total UMI counts per sample
total_umi_stats <- vis_mod_anno@meta.data %>%
  group_by(patient_method) %>%
  summarize(
    mean_total_UMI = mean(nCount_Spatial),
    median_total_UMI = median(nCount_Spatial),
    total_spots = n()
  )

```




